<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VS Code Web Editor (Dark Theme + Firebase Save/Load)</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  html, body {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #1e1e1e;
    color: #d4d4d4;
    overflow: hidden;
  }
  /* Layout container */
  #app {
    display: flex;
    height: 100vh;
    width: 100vw;
  }
  /* Sidebar - Explorer */
  #sidebar {
    width: 240px;
    background-color: #252526;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #333;
    user-select: none;
    position: relative;
    z-index: 10;
  }
  #sidebar header {
    font-weight: 600;
    font-size: 14px;
    padding: 12px 16px;
    border-bottom: 1px solid #333;
    color: #ccc;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #file-explorer {
    flex: 1;
    overflow-y: auto;
    padding: 10px 0;
  }
  ul.file-list {
    list-style: none;
    margin: 0; padding: 0;
  }
  ul.file-list li {
    padding: 6px 12px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    border-radius: 3px;
  }
  ul.file-list li:hover:not(.active) {
    background-color: #333333;
  }
  ul.file-list li.active {
    background-color: #094771;
    color: white;
  }
  ul.file-list li button.delete-file {
    background: transparent;
    border: none;
    color: #888;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    padding: 0 4px;
  }
  ul.file-list li button.delete-file:hover {
    color: #e81123;
  }
  #new-file-container {
    padding: 10px 16px;
    border-top: 1px solid #333;
  }
  #new-file-container input {
    width: calc(100% - 80px);
    padding: 6px 8px;
    font-size: 13px;
    border: none;
    border-radius: 3px;
  }
  #new-file-container button {
    width: 60px;
    margin-left: 8px;
    padding: 6px 0;
    background-color: #0e639c;
    border: none;
    color: white;
    border-radius: 3px;
    font-size: 13px;
    cursor: pointer;
  }
  #new-file-container button:hover {
    background-color: #1177cc;
  }

  /* Add Save/Load buttons container */
  #save-load-container {
    display: flex;
    justify-content: space-around;
    padding: 8px 16px;
    border-top: 1px solid #333;
    background: #1e1e1e;
  }
  #save-load-container button {
    flex: 1;
    margin: 0 5px;
    background-color: #0e639c;
    border: none;
    color: white;
    border-radius: 3px;
    font-size: 13px;
    cursor: pointer;
    padding: 6px 0;
  }
  #save-load-container button:hover {
    background-color: #1177cc;
  }

  /* Main editor area */
  #main-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    background-color: #1e1e1e;
    min-height: 0; /* important for flex */
    position: relative;
    z-index: 5;
  }

  /* Tabs bar */
  #tab-bar {
    height: 38px;
    background-color: #252526;
    border-bottom: 1px solid #333;
    display: flex;
    align-items: center;
    padding-left: 10px;
    overflow-x: auto;
    scrollbar-width: none; /* Firefox */
  }
  #tab-bar::-webkit-scrollbar {
    display: none; /* Chrome */
  }
  .tab {
    display: flex;
    align-items: center;
    background-color: #2d2d2d;
    color: #ccc;
    padding: 6px 12px;
    margin-right: 2px;
    font-size: 13px;
    border-top-left-radius: 3px;
    border-top-right-radius: 3px;
    cursor: pointer;
    user-select: none;
    position: relative;
  }
  .tab.active {
    background-color: #1e1e1e;
    color: white;
    border-bottom: 1px solid #1e1e1e;
  }
  .tab:hover:not(.active) {
    background-color: #3c3c3c;
    color: white;
  }
  .tab .close-btn {
    margin-left: 8px;
    font-weight: 700;
    color: #888;
    cursor: pointer;
    font-size: 14px;
  }
  .tab .close-btn:hover {
    color: #e81123;
  }

  /* Editor container */
  #editor-container {
    flex: 1;
    min-height: 0; /* important for flex */
    position: relative;
  }
  #code-editor {
    height: 100%;
    width: 100%;
    outline: none;
    position: relative;
    z-index: 1;
  }

  /* Status bar */
  #status-bar {
    height: 22px;
    background-color: #007acc;
    color: white;
    font-size: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 12px;
    user-select: none;
  }

  /* PS5 Insert Buttons Overlay */
  #ps5-buttons {
    position: absolute;
    bottom: 40px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    pointer-events: auto;
    z-index: 10;
  }
  #ps5-buttons button {
    background-color: #0e639c;
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 3px;
    font-size: 14px;
    cursor: pointer;
    pointer-events: auto;
  }
  #ps5-buttons button:hover {
    background-color: #1177cc;
  }
</style>
</head>
<body>

<div id="app">

  <!-- Sidebar -->
  <nav id="sidebar" aria-label="File Explorer">
    <header>EXPLORER</header>
    <div id="file-explorer">
      <ul class="file-list" id="file-list">
        <!-- Files will appear here -->
      </ul>
    </div>
    <div id="new-file-container">
      <input type="text" id="new-file-name" placeholder="New file name..." aria-label="New file name" />
      <button id="btn-add-file" aria-label="Add new file">Add</button>
    </div>
    <div id="save-load-container">
      <button id="btn-save-files" aria-label="Save files to Firebase">Save</button>
      <button id="btn-load-files" aria-label="Load files from Firebase">Load</button>
    </div>
  </nav>

  <!-- Main editor area -->
  <main id="main-area" role="main">
    <div id="tab-bar" role="tablist" aria-label="Open files">
      <!-- Tabs will be added here -->
    </div>
    <div id="editor-container">
      <!-- CodeMirror editor will mount here -->
      <div id="code-editor" spellcheck="false" aria-label="Code editor"></div>

      <!-- PS5 buttons overlay -->
      <div id="ps5-buttons" aria-label="PS5 editor controls">
        <button id="btn-insert-tab" title="Insert Tab (2 spaces)">Tab</button>
        <button id="btn-insert-newline" title="Insert Newline">Newline</button>
      </div>
    </div>
    <footer id="status-bar" aria-live="polite">
      <div id="status-left">Ready</div>
      <div id="status-right">Ln 1, Col 1</div>
    </footer>
  </main>

</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- CodeMirror 6 modules -->
<script type="module">
  import {EditorState, Compartment} from "https://cdn.jsdelivr.net/npm/@codemirror/state@6.2.1/dist/index.min.js";
  import {EditorView, keymap, highlightActiveLine, highlightActiveLineGutter} from "https://cdn.jsdelivr.net/npm/@codemirror/view@6.9.1/dist/index.min.js";
  import {defaultKeymap, history, historyKeymap} from "https://cdn.jsdelivr.net/npm/@codemirror/commands@6.5.1/dist/index.min.js";
  import {javascript} from "https://cdn.jsdelivr.net/npm/@codemirror/lang-javascript@6.1.4/dist/index.min.js";
  import {html} from "https://cdn.jsdelivr.net/npm/@codemirror/lang-html@6.2.0/dist/index.min.js";
  import {python} from "https://cdn.jsdelivr.net/npm/@codemirror/lang-python@6.2.0/dist/index.min.js";
  import {oneDark} from "https://cdn.jsdelivr.net/npm/@codemirror/theme-one-dark@6.2.0/dist/index.min.js";
  import {syntaxHighlighting, defaultHighlightStyle} from "https://cdn.jsdelivr.net/npm/@codemirror/language@6.7.0/dist/index.min.js";

  // Firebase config - REPLACE WITH YOUR ACTUAL CONFIG
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // Elements
  const fileListEl = document.getElementById('file-list');
  const newFileNameInput = document.getElementById('new-file-name');
  const btnAddFile = document.getElementById('btn-add-file');
  const tabBar = document.getElementById('tab-bar');
  const codeEditorDiv = document.getElementById('code-editor');
  const statusLeft = document.getElementById('status-left');
  const statusRight = document.getElementById('status-right');
  const btnSaveFiles = document.getElementById('btn-save-files');
  const btnLoadFiles = document.getElementById('btn-load-files');
  const btnInsertTab = document.getElementById('btn-insert-tab');
  const btnInsertNewline = document.getElementById('btn-insert-newline');

  // Files data structure: { filename: { content, language } }
  const files = {};
  let openTabs = [];
  let activeFile = null;
  let cmView = null;  // CodeMirror editor instance

  // Helper: detect language by file extension
  function detectLanguage(filename) {
    if(filename.endsWith('.html')) return 'html';
    if(filename.endsWith('.css')) return 'css';
    if(filename.endsWith('.js')) return 'javascript';
    if(filename.endsWith('.py')) return 'python';
    return 'plaintext';
  }

  // Add file to files and UI
  function addFile(name) {
    if(!name) {
      alert('Please enter a file name');
      return;
    }
    if(files[name]) {
      alert('File already exists');
      return;
    }
    files[name] = { content: '', language: detectLanguage(name) };
    renderFileList();
    openFile(name);
    newFileNameInput.value = '';
  }

  // Render sidebar file list
  function renderFileList() {
    fileListEl.innerHTML = '';
    Object.keys(files).forEach(name => {
      const li = document.createElement('li');
      li.textContent = name;
      li.tabIndex = 0;
      li.setAttribute('role', 'button');
      if(name === activeFile) li.classList.add('active');
      li.onclick = () => openFile(name);
      li.onkeydown = e => { if(e.key === 'Enter' || e.key === ' ') openFile(name); };

      const delBtn = document.createElement('button');
      delBtn.textContent = '×';
      delBtn.title = 'Delete file';
      delBtn.className = 'delete-file';
      delBtn.onclick = e => {
        e.stopPropagation();
        if(confirm(`Delete file "${name}"?`)) {
          closeFile(name);
          delete files[name];
          if(activeFile === name) {
            activeFile = null;
            if(Object.keys(files).length) openFile(Object.keys(files)[0]);
            else renderTabs();
          }
          renderFileList();
        }
      };
      li.appendChild(delBtn);

      fileListEl.appendChild(li);
    });
  }

  // Render tabs
  function renderTabs() {
    tabBar.innerHTML = '';
    openTabs.forEach(name => {
      const tab = document.createElement('div');
      tab.className = 'tab' + (name === activeFile ? ' active' : '');
      tab.textContent = name;
      tab.title = name;
      tab.onclick = () => openFile(name);

      const closeBtn = document.createElement('span');
      closeBtn.className = 'close-btn';
      closeBtn.textContent = '×';
      closeBtn.title = 'Close file';
      closeBtn.onclick = e => {
        e.stopPropagation();
        closeFile(name);
      };
      tab.appendChild(closeBtn);

      tabBar.appendChild(tab);
    });
  }

  // Open a file in editor
  function openFile(name) {
    if(!files[name]) return;

    // Save current file content before switch
    if(activeFile && cmView) {
      files[activeFile].content = cmView.state.doc.toString();
    }
    activeFile = name;
    if(!openTabs.includes(name)) openTabs.push(name);
    renderTabs();
    renderFileList();
    loadFileContent(name);
  }

  // Close a file tab
  function closeFile(name) {
    if(activeFile === name && cmView) {
      files[name].content = cmView.state.doc.toString();
      activeFile = null;
    }
    openTabs = openTabs.filter(n => n !== name);
    renderTabs();
    if(!activeFile && openTabs.length) openFile(openTabs[0]);
    else if(openTabs.length === 0) {
      // No files open
      if(cmView) {
        cmView.destroy();
        cmView = null;
      }
      codeEditorDiv.textContent = '';
      updateStatusBar();
    }
  }

  // Load file content into CodeMirror
  function loadFileContent(name) {
    if(cmView) {
      cmView.destroy();
      cmView = null;
    }

    const language = files[name].language;
    let languageExtension = [];
    switch(language) {
      case 'javascript': languageExtension = [javascript()]; break;
      case 'html': languageExtension = [html()]; break;
      case 'python': languageExtension = [python()]; break;
      case 'css': languageExtension = []; break;
      default: languageExtension = [];
    }

    cmView = new EditorView({
      state: EditorState.create({
        doc: files[name].content,
        extensions: [
          keymap.of([...defaultKeymap, ...historyKeymap]),
          history(),
          syntaxHighlighting(defaultHighlightStyle, {fallback: true}),
          highlightActiveLine(),
          highlightActiveLineGutter(),
          oneDark,
          ...languageExtension,
          EditorView.updateListener.of(update => {
            if (update.docChanged || update.selectionSet) {
              updateStatusBar();
            }
          })
        ]
      }),
      parent: codeEditorDiv
    });

    updateStatusBar();
    cmView.focus();
  }

  // Update status bar line and column
  function updateStatusBar() {
    if(!cmView) {
      statusRight.textContent = "Ln 1, Col 1";
      return;
    }
    const selection = cmView.state.selection.main;
    const line = cmView.state.doc.lineAt(selection.head);
    const col = selection.head - line.from + 1;
    statusRight.textContent = `Ln ${line.number}, Col ${col}`;
  }

  // Insert text helper for buttons
  function insertAtCursor(text) {
    if(!cmView) return;
    const {state, dispatch} = cmView;
    const changes = {from: state.selection.main.from, to: state.selection.main.to, insert: text};
    dispatch(state.update({changes, selection: {anchor: state.selection.main.from + text.length}}));
    cmView.focus();
  }

  // PS5 buttons events
  btnInsertTab.onclick = () => insertAtCursor('  ');
  btnInsertNewline.onclick = () => insertAtCursor('\n');

  // Add new file button events
  btnAddFile.onclick = () => addFile(newFileNameInput.value.trim());
  newFileNameInput.addEventListener('keydown', e => {
    if(e.key === 'Enter') addFile(newFileNameInput.value.trim());
  });

  // Firebase save/load paths
  const firebaseDbPath = 'webEditorFiles';

  btnSaveFiles.onclick = () => {
    if(!Object.keys(files).length) {
      alert('No files to save');
      return;
    }
    // Save files to Firebase under user key or generic key
    database.ref(firebaseDbPath).set(files)
      .then(() => alert('Files saved successfully'))
      .catch(err => alert('Save failed: ' + err.message));
  };

  btnLoadFiles.onclick = () => {
    database.ref(firebaseDbPath).get()
      .then(snapshot => {
        if(snapshot.exists()) {
          const loadedFiles = snapshot.val();
          Object.keys(loadedFiles).forEach(name => {
            files[name] = loadedFiles[name];
          });
          // Open first file loaded
          if(Object.keys(files).length) {
            openTabs = [];
            activeFile = null;
            openFile(Object.keys(files)[0]);
            renderFileList();
            renderTabs();
            alert('Files loaded successfully');
          } else {
            alert('No files found in database');
          }
        } else {
          alert('No saved files found');
        }
      })
      .catch(err => alert('Load failed: ' + err.message));
  };

  // Initialization: create a default welcome file if empty
  if(Object.keys(files).length === 0) {
    files['welcome.html'] = {content: '<!-- Welcome to your editor! -->\n', language: 'html'};
    openFile('welcome.html');
    renderFileList();
    renderTabs();
  }

</script>
</body>
</html>