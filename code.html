<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VS Code Web Clone</title>
<style>
  /* === Variables & Reset === */
  :root {
    --bg: #1e1e1e;
    --sidebar-bg: #252526;
    --panel-bg: #333333;
    --text-color: #d4d4d4;
    --tab-bg: #2d2d2d;
    --tab-active-bg: #1e1e1e;
    --tab-border: #3c3c3c;
    --accent: #007acc;
    --status-bg: #007acc;
    --error-color: #e81123;
    --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    --font-mono: Consolas, 'Courier New', monospace;
  }
  * {
    margin:0; padding:0; box-sizing: border-box;
  }
  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--text-color);
    font-family: var(--font-family);
    user-select: none;
    overflow: hidden;
  }
  button {
    cursor: pointer;
  }
  button:focus {
    outline: 2px solid var(--accent);
    outline-offset: 1px;
  }

  /* === Layout === */
  #app {
    display: flex;
    height: 100vh;
    width: 100vw;
  }

  /* Sidebar */
  #sidebar {
    width: 48px;
    background: var(--sidebar-bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px 0;
    border-right: 1px solid var(--tab-border);
  }
  #sidebar button {
    background: none;
    border: none;
    color: var(--text-color);
    font-size: 20px;
    margin: 8px 0;
    width: 32px;
    height: 32px;
    line-height: 32px;
    text-align: center;
    border-radius: 6px;
    transition: background 0.2s;
  }
  #sidebar button:hover,
  #sidebar button.active {
    background: var(--accent);
    color: white;
  }

  /* Panels container */
  #panel-container {
    flex: 1;
    display: flex;
    flex-direction: row;
    overflow: hidden;
  }

  /* Explorer panel */
  #explorer {
    width: 240px;
    background: var(--sidebar-bg);
    border-right: 1px solid var(--tab-border);
    display: flex;
    flex-direction: column;
  }
  #explorer header {
    color: #ccc;
    font-weight: 700;
    padding: 12px 16px;
    font-size: 13px;
    border-bottom: 1px solid var(--tab-border);
    user-select: none;
  }
  #file-tree {
    flex: 1;
    overflow-y: auto;
    padding: 10px 12px;
  }
  ul.tree {
    list-style: none;
    padding-left: 16px;
  }
  ul.tree li {
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 4px;
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    user-select: none;
  }
  ul.tree li:hover {
    background: #333333;
  }
  ul.tree li.active {
    background: var(--accent);
    color: white;
  }
  ul.tree li.folder > span.toggle {
    cursor: pointer;
    margin-right: 6px;
    user-select: none;
  }
  ul.tree li.folder > span.toggle::before {
    content: '‚ñ∂';
    display: inline-block;
    transform-origin: center;
    transition: transform 0.15s ease;
  }
  ul.tree li.folder.expanded > span.toggle::before {
    transform: rotate(90deg);
  }
  ul.tree li.folder > ul {
    display: none;
  }
  ul.tree li.folder.expanded > ul {
    display: block;
  }
  ul.tree li button.delete-file {
    background: transparent;
    border: none;
    color: #888;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    margin-left: 8px;
    border-radius: 4px;
    padding: 0 6px;
  }
  ul.tree li button.delete-file:hover {
    color: var(--error-color);
  }

  #new-file-container {
    padding: 10px 16px;
    border-top: 1px solid var(--tab-border);
    display: flex;
    gap: 6px;
  }
  #new-file-name {
    flex: 1;
    padding: 6px 8px;
    font-size: 13px;
    border-radius: 4px;
    border: none;
    outline: none;
  }
  #btn-add-file {
    background: var(--accent);
    border: none;
    color: white;
    font-weight: 700;
    font-size: 13px;
    padding: 6px 12px;
    border-radius: 4px;
    transition: background 0.3s;
  }
  #btn-add-file:hover {
    background: #3399ff;
  }

  /* Editor & Tabs container */
  #editor-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg);
  }

  /* Tab bar */
  #tab-bar {
    height: 38px;
    background: var(--tab-bg);
    border-bottom: 1px solid var(--tab-border);
    display: flex;
    align-items: center;
    padding-left: 12px;
    user-select: none;
    overflow-x: auto;
    scrollbar-width: none; /* Firefox */
  }
  #tab-bar::-webkit-scrollbar {
    display: none; /* Chrome */
  }
  .tab {
    display: flex;
    align-items: center;
    padding: 6px 12px;
    margin-right: 4px;
    border-top-left-radius: 4px;
    border-top-right-radius: 4px;
    background: var(--tab-bg);
    color: var(--text-color);
    font-size: 13px;
    cursor: pointer;
    position: relative;
    white-space: nowrap;
  }
  .tab.active {
    background: var(--tab-active-bg);
    border-bottom: 1px solid var(--tab-active-bg);
    color: white;
    font-weight: 700;
  }
  .tab:hover:not(.active) {
    background: #3c3c3c;
  }
  .tab .close-tab {
    margin-left: 10px;
    font-weight: 700;
    color: #888;
    cursor: pointer;
    user-select: none;
  }
  .tab .close-tab:hover {
    color: var(--error-color);
  }

  /* Editor area */
  #code-area {
    flex: 1;
    position: relative;
    background: var(--bg);
    display: flex;
    flex-direction: column;
  }

  #code-editor {
    flex: 1;
    background: transparent;
    color: var(--text-color);
    border: none;
    font-family: var(--font-mono);
    font-size: 14px;
    padding: 12px 14px;
    line-height: 1.4;
    resize: none;
    outline: none;
    overflow: auto;
    white-space: pre;
  }

  /* Overlay preview panel */
  #preview-overlay {
    position: absolute;
    top: 38px; /* below tab bar */
    left: 0;
    right: 0;
    bottom: 0;
    background: #121212;
    border-top: 1px solid var(--tab-border);
    z-index: 10;
    display: none;
    flex-direction: column;
  }
  #preview-toolbar {
    height: 32px;
    background: var(--panel-bg);
    display: flex;
    align-items: center;
    padding: 0 10px;
    border-bottom: 1px solid var(--tab-border);
  }
  #preview-toolbar button {
    background: none;
    border: none;
    color: var(--text-color);
    font-size: 14px;
    cursor: pointer;
    margin-left: auto;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background 0.2s;
  }
  #preview-toolbar button:hover {
    background: var(--accent);
  }
  #preview-iframe {
    flex: 1;
    border: none;
    background: white;
  }

  /* PS5 Buttons */
  #ps5-buttons {
    position: absolute;
    bottom: 40px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    z-index: 20;
  }
  #ps5-buttons button {
    background: var(--accent);
    border: none;
    color: white;
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
  }
  #ps5-buttons button:hover {
    background: #3399ff;
  }

  /* Status bar */
  #status-bar {
    height: 22px;
    background: var(--status-bg);
    color: white;
    font-size: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 12px;
    user-select: none;
  }
  #status-left {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  #status-right {
    font-family: var(--font-mono);
  }

  /* Scrollbar styling */
  #file-tree::-webkit-scrollbar,
  #code-editor::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  #file-tree::-webkit-scrollbar-thumb,
  #code-editor::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 4px;
  }
  #file-tree::-webkit-scrollbar-track,
  #code-editor::-webkit-scrollbar-track {
    background: #222;
  }

  /* Search Panel */
  #search-panel {
    width: 320px;
    background: var(--sidebar-bg);
    border-left: 1px solid var(--tab-border);
    display: none;
    flex-direction: column;
  }
  #search-panel header {
    color: #ccc;
    font-weight: 700;
    padding: 12px 16px;
    font-size: 13px;
    border-bottom: 1px solid var(--tab-border);
    user-select: none;
  }
  #search-input {
    padding: 8px 12px;
    margin: 10px 16px;
    font-size: 13px;
    border-radius: 4px;
    border: none;
    outline: none;
    font-family: var(--font-mono);
  }
  #search-results {
    flex: 1;
    overflow-y: auto;
    padding: 0 16px 10px 16px;
    font-size: 12px;
  }
  #search-results div.result-item {
    padding: 6px 8px;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    white-space: pre-wrap;
    word-break: break-word;
  }
  #search-results div.result-item:hover {
    background: #3a3d41;
  }

  /* Run & Debug Panel */
  #run-panel {
    width: 320px;
    background: var(--sidebar-bg);
    border-left: 1px solid var(--tab-border);
    display: none;
    flex-direction: column;
    color: var(--text-color);
    font-size: 13px;
    padding: 12px;
  }

  /* Extensions Panel */
  #extensions-panel {
    width: 320px;
    background: var(--sidebar-bg);
    border-left: 1px solid var(--tab-border);
    display: none;
    flex-direction: column;
    color: var(--text-color);
    font-size: 13px;
    padding: 12px;
  }

  /* Folder/File Icons */
  .icon-folder::before {
    content: "üìÅ";
    margin-right: 6px;
  }
  .icon-file::before {
    content: "üìÑ";
    margin-right: 6px;
  }
</style>
</head>
<body>

<div id="app" role="application" aria-label="Visual Studio Code Web Clone">

  <!-- Sidebar with icons -->
  <nav id="sidebar" aria-label="Sidebar">
    <button id="btn-explorer" title="Explorer" aria-pressed="true" aria-label="Show Explorer panel">üìÅ</button>
    <button id="btn-search" title="Search" aria-pressed="false" aria-label="Show Search panel">üîç</button>
    <button id="btn-run" title="Run & Debug" aria-pressed="false" aria-label="Show Run and Debug panel">‚ñ∂Ô∏è</button>
    <button id="btn-extensions" title="Extensions" aria-pressed="false" aria-label="Show Extensions panel">üß©</button>
  </nav>

  <!-- Panels container -->
  <section id="panel-container">

    <!-- Explorer panel -->
    <section id="explorer" role="region" aria-label="File Explorer" tabindex="0">
      <header>EXPLORER</header>
      <div id="file-tree" tabindex="0" aria-label="File tree"></div>
      <div id="new-file-container">
        <input id="new-file-name" type="text" aria-label="New file name" placeholder="New file name or folder (end with /)" />
        <button id="btn-add-file" aria-label="Add new file or folder">Add</button>
      </div>
    </section>

    <!-- Editor container -->
    <section id="editor-container" role="main">

      <!-- Tabs bar -->
      <div id="tab-bar" role="tablist" aria-label="Open files"></div>

      <!-- Code editing area -->
      <div id="code-area">
        <textarea id="code-editor" spellcheck="false" aria-label="Code editor"></textarea>

        <!-- Preview overlay -->
        <div id="preview-overlay" role="region" aria-label="Live preview">
          <div id="preview-toolbar">
            <button id="btn-close-preview" aria-label="Close preview">Close Preview ‚úï</button>
          </div>
          <iframe id="preview-iframe" sandbox="allow-scripts allow-same-origin"></iframe>
        </div>

        <!-- PS5 buttons -->
        <div id="ps5-buttons" aria-label="PS5 editor controls">
          <button id="btn-insert-tab" title="Insert tab (2 spaces)">Tab</button>
          <button id="btn-insert-newline" title="Insert newline">Newline</button>
        </div>
      </div>

      <!-- Status bar -->
      <footer id="status-bar" aria-live="polite">
        <div id="status-left">Ready</div>
        <div id="status-right">Ln 1, Col 1</div>
      </footer>

    </section>

    <!-- Search panel -->
    <section id="search-panel" role="region" aria-label="Search panel" tabindex="0">
      <header>SEARCH</header>
      <input id="search-input" type="search" placeholder="Search files..." aria-label="Search files" />
      <div id="search-results" aria-live="polite" aria-relevant="additions"></div>
    </section>

    <!-- Run & Debug panel -->
    <section id="run-panel" role="region" aria-label="Run and Debug panel" tabindex="0">
      <header>RUN & DEBUG</header>
      <p style="padding: 12px;">(Coming soon...)</p>
    </section>

    <!-- Extensions panel -->
    <section id="extensions-panel" role="region" aria-label="Extensions panel" tabindex="0">
      <header>EXTENSIONS</header>
      <p style="padding: 12px;">(Coming soon...)</p>
    </section>

  </section>

</div>

<script>
  // === Data Structures ===
  let files = {
    "index.html": "<!-- Start coding here -->\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <title>My Page</title>\n</head>\n<body>\n  <h1>Hello world!</h1>\n</body>\n</html>",
    "style.css": "body {\n  background-color: #121212;\n  color: white;\n  font-family: sans-serif;\n}\n",
    "script.js": "console.log('Hello from JS!');\n",
    "folder/": {}
  };

  // Store folder structure as nested objects. Flat files have string values.
  // Files with key ending with "/" are folders with nested contents.

  // Current open tabs and active file
  let openTabs = [];
  let activeFile = null;

  // UI elements
  const fileTreeEl = document.getElementById('file-tree');
  const tabBarEl = document.getElementById('tab-bar');
  const codeEditorEl = document.getElementById('code-editor');
  const previewOverlayEl = document.getElementById('preview-overlay');
  const previewIframeEl = document.getElementById('preview-iframe');
  const statusLeftEl = document.getElementById('status-left');
  const statusRightEl = document.getElementById('status-right');
  const btnInsertTab = document.getElementById('btn-insert-tab');
  const btnInsertNewline = document.getElementById('btn-insert-newline');
  const btnClosePreview = document.getElementById('btn-close-preview');

  const btnExplorer = document.getElementById('btn-explorer');
  const btnSearch = document.getElementById('btn-search');
  const btnRun = document.getElementById('btn-run');
  const btnExtensions = document.getElementById('btn-extensions');

  const explorerPanel = document.getElementById('explorer');
  const searchPanel = document.getElementById('search-panel');
  const runPanel = document.getElementById('run-panel');
  const extensionsPanel = document.getElementById('extensions-panel');

  const newFileInput = document.getElementById('new-file-name');
  const btnAddFile = document.getElementById('btn-add-file');

  // === Functions ===

  // Deep clone for files object
  function cloneFiles(obj) {
    return JSON.parse(JSON.stringify(obj));
  }

  // Save files object to localStorage
  function saveFiles() {
    localStorage.setItem('vsweb-files', JSON.stringify(files));
  }
  // Load files from localStorage or default
  function loadFiles() {
    const data = localStorage.getItem('vsweb-files');
    if(data) {
      try {
        files = JSON.parse(data);
      } catch {
        files = {};
      }
    }
  }

  // Check if a key is folder
  function isFolder(key) {
    return key.endsWith('/');
  }

  // Render file tree recursively
  function renderFileTree(container, treeObj, path='') {
    container.innerHTML = '';
    const ul = document.createElement('ul');
    ul.classList.add('tree');
    buildTree(ul, treeObj, path);
    container.appendChild(ul);
  }
  function buildTree(parentUl, treeObj, basePath) {
    for (const key in treeObj) {
      const fullPath = basePath + key;
      const li = document.createElement('li');

      if (isFolder(key)) {
        li.classList.add('folder');
        li.setAttribute('aria-expanded', 'false');
        const toggleSpan = document.createElement('span');
        toggleSpan.classList.add('toggle');
        toggleSpan.tabIndex = 0;
        toggleSpan.setAttribute('role', 'button');
        toggleSpan.setAttribute('aria-label', 'Toggle folder ' + key.slice(0, -1));
        toggleSpan.addEventListener('click', e => {
          e.stopPropagation();
          li.classList.toggle('expanded');
          const expanded = li.classList.contains('expanded');
          li.setAttribute('aria-expanded', expanded);
        });
        toggleSpan.addEventListener('keydown', e => {
          if(e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggleSpan.click();
          }
        });
        toggleSpan.textContent = '';
        li.appendChild(toggleSpan);

        const folderName = document.createElement('span');
        folderName.textContent = key.slice(0, -1);
        folderName.classList.add('icon-folder');
        folderName.tabIndex = 0;
        folderName.setAttribute('role', 'treeitem');
        folderName.setAttribute('aria-expanded', 'false');
        folderName.addEventListener('click', () => {
          toggleSpan.click();
        });
        folderName.addEventListener('keydown', e => {
          if(e.key === 'Enter') {
            e.preventDefault();
            toggleSpan.click();
          }
        });
        li.appendChild(folderName);

        const innerUl = document.createElement('ul');
        innerUl.style.display = 'none';
        li.appendChild(innerUl);

        if (files[key]) {
          buildTree(innerUl, files[key], fullPath);
        }

        parentUl.appendChild(li);
      } else {
        li.classList.add('file');
        li.textContent = key;
        li.classList.add('icon-file');
        li.tabIndex = 0;
        li.setAttribute('role', 'treeitem');
        li.addEventListener('click', () => {
          openFile(fullPath);
        });
        li.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            openFile(fullPath);
          }
        });

        // Delete button
        const delBtn = document.createElement('button');
        delBtn.textContent = '√ó';
        delBtn.classList.add('delete-file');
        delBtn.title = 'Delete file';
        delBtn.addEventListener('click', e => {
          e.stopPropagation();
          if(confirm('Delete file "'+ fullPath +'"?')) {
            deleteFile(fullPath);
          }
        });
        li.appendChild(delBtn);

        parentUl.appendChild(li);
      }
    }
  }

  // Resolve file/folder parent object by path (like "folder/file.txt")
  function getParentFolder(path) {
    const parts = path.split('/');
    if(parts.length === 1) return files;
    parts.pop();
    let obj = files;
    for(const p of parts) {
      if(p === '') continue;
      obj = obj[p + '/'];
      if(!obj) return null;
    }
    return obj;
  }

  // Delete file or folder
  function deleteFile(path) {
    const parent = getParentFolder(path);
    if(!parent) return;
    const parts = path.split('/');
    const key = parts[parts.length - 1];
    delete parent[key];
    saveFiles();
    refreshFileTree();
    if(activeFile === path) closeTab(path);
  }

  // Add new file or folder
  function addNewFile(name) {
    if(!name) return alert('Please enter a file or folder name.');
    if(name.includes('\\')) return alert('Invalid character \\ not allowed.');
    if(name.startsWith('/')) name = name.slice(1);
    const isFolder = name.endsWith('/');
    let parent = files;
    let parts = name.split('/');
    if(parts.length > 1) {
      const last = parts.pop();
      for(const part of parts) {
        if(!parent[part + '/']) parent[part + '/'] = {};
        parent = parent[part + '/'];
      }
      if(isFolder) {
        parent[last + '/'] = parent[last + '/'] || {};
      } else {
        if(parent[last]) return alert('File already exists.');
        parent[last] = '';
      }
    } else {
      if(isFolder) {
        if(files[name]) return alert('Folder already exists.');
        files[name] = {};
      } else {
        if(files[name]) return alert('File already exists.');
        files[name] = '';
      }
    }
    saveFiles();
    refreshFileTree();
    newFileInput.value = '';
  }

  // Open file in tab and editor
  function openFile(path) {
    if(!filesExists(path)) return alert('File does not exist.');
    if(openTabs.includes(path)) {
      setActiveTab(path);
      return;
    }
    openTabs.push(path);
    renderTabs();
    setActiveTab(path);
  }

  // Check if file exists (resolving nested folders)
  function filesExists(path) {
    const parts = path.split('/');
    let obj = files;
    for(let i = 0; i < parts.length; i++) {
      let p = parts[i];
      if(i === parts.length - 1) {
        // last part: file
        if(obj[p] !== undefined) return true;
        if(obj[p + '/'] !== undefined) return false;
        return false;
      } else {
        if(obj[p + '/'] !== undefined) obj = obj[p + '/'];
        else return false;
      }
    }
    return false;
  }

  // Render tabs
  function renderTabs() {
    tabBarEl.innerHTML = '';
    for(const path of openTabs) {
      const tab = document.createElement('div');
      tab.className = 'tab';
      if(path === activeFile) tab.classList.add('active');
      tab.textContent = fileNameFromPath(path);
      tab.title = path;

      // Close button
      const closeBtn = document.createElement('span');
      closeBtn.className = 'close-tab';
      closeBtn.textContent = '√ó';
      closeBtn.title = 'Close tab';
      closeBtn.addEventListener('click', e => {
        e.stopPropagation();
        closeTab(path);
      });

      tab.appendChild(closeBtn);
      tab.addEventListener('click', () => setActiveTab(path));

      tabBarEl.appendChild(tab);
    }
  }

  // Get file name from path
  function fileNameFromPath(path) {
    if(path.endsWith('/')) return path.slice(0, -1);
    return path.split('/').pop();
  }

  // Set active tab
  function setActiveTab(path) {
    if(!openTabs.includes(path)) return;
    activeFile = path;
    renderTabs();
    loadFileToEditor(path);
  }

  // Load file content to editor
  function loadFileToEditor(path) {
    const content = getFileContent(path);
    codeEditorEl.value = content;
    updateStatusBar();
    codeEditorEl.focus();
  }

  // Get file content from nested files object
  function getFileContent(path) {
    const parts = path.split('/');
    let obj = files;
    for(let i = 0; i < parts.length; i++) {
      let p = parts[i];
      if(i === parts.length - 1) {
        return obj[p] || '';
      } else {
        obj = obj[p + '/'];
        if(!obj) return '';
      }
    }
    return '';
  }

  // Save editor content to files object
  function saveEditorContent() {
    if(!activeFile) return;
    let parent = getParentFolder(activeFile);
    if(!parent) return;
    const fileName = activeFile.split('/').pop();
    parent[fileName] = codeEditorEl.value;
    saveFiles();
  }

  // Close tab
  function closeTab(path) {
    openTabs = openTabs.filter(p => p !== path);
    if(activeFile === path) {
      if(openTabs.length > 0) {
        setActiveTab(openTabs[openTabs.length - 1]);
      } else {
        activeFile = null;
        codeEditorEl.value = '';
      }
    }
    renderTabs();
  }

  // Update status bar (line, column)
  function updateStatusBar() {
    const pos = codeEditorEl.selectionStart;
    const lines = codeEditorEl.value.substr(0, pos).split('\n');
    const line = lines.length;
    const col = lines[lines.length - 1].length + 1;
    statusRightEl.textContent = `Ln ${line}, Col ${col}`;

    statusLeftEl.textContent = activeFile ? fileNameFromPath(activeFile) : 'Ready';
  }

  // Insert text at cursor position in textarea
  function insertAtCursor(text) {
    const start = codeEditorEl.selectionStart;
    const end = codeEditorEl.selectionEnd;
    const val = codeEditorEl.value;
    codeEditorEl.value = val.substring(0, start) + text + val.substring(end);
    codeEditorEl.selectionStart = codeEditorEl.selectionEnd = start + text.length;
    codeEditorEl.focus();
    updateStatusBar();
    saveEditorContent();
  }

  // Syntax highlight basic (for display below textarea, optional)
  // For now, skipped because complex in textarea.
  // Can consider replacing textarea with contenteditable or CodeMirror later.

  // Preview update
  function updatePreview() {
    if(!activeFile) return;
    // We try to generate HTML preview if current file is html or if index.html exists
    let htmlToShow = '';
    if(activeFile.endsWith('.html')) {
      htmlToShow = codeEditorEl.value;
    } else if (files['index.html']) {
      htmlToShow = files['index.html'];
    }
    const blob = new Blob([htmlToShow], {type: 'text/html'});
    const url = URL.createObjectURL(blob);
    previewIframeEl.src = url;
  }

  // Toggle preview overlay
  function togglePreview(show) {
    if(show === undefined) {
      show = previewOverlayEl.style.display === 'flex' ? false : true;
    }
    previewOverlayEl.style.display = show ? 'flex' : 'none';
    if(show) {
      updatePreview();
    } else {
      previewIframeEl.src = 'about:blank';
      codeEditorEl.focus();
    }
  }

  // Search logic
  function performSearch(query) {
    const resultsEl = document.getElementById('search-results');
    resultsEl.innerHTML = '';
    if(!query) return;
    query = query.toLowerCase();
    // Search all files content
    function recurseFiles(obj, base='') {
      for(const key in obj) {
        if(isFolder(key)) {
          recurseFiles(obj[key], base + key);
        } else {
          const content = obj[key].toLowerCase();
          if(content.includes(query)) {
            const snippet = getSnippet(obj[key], query);
            const div = document.createElement('div');
            div.className = 'result-item';
            div.textContent = `${base + key}: ${snippet}`;
            div.title = base + key;
            div.tabIndex = 0;
            div.addEventListener('click', () => {
              openFile(base + key);
              togglePreview(false);
            });
            div.addEventListener('keydown', e => {
              if(e.key === 'Enter') div.click();
            });
            resultsEl.appendChild(div);
          }
        }
      }
    }
    recurseFiles(files);
  }
  function getSnippet(text, query) {
    const idx = text.toLowerCase().indexOf(query);
    if(idx === -1) return '';
    const start = Math.max(0, idx - 10);
    const end = Math.min(text.length, idx + query.length + 10);
    return '...' + text.substring(start, end).replace(/\n/g,' ') + '...';
  }

  // Panel switching
  function showPanel(name) {
    [explorerPanel, searchPanel, runPanel, extensionsPanel].forEach(p => {
      p.style.display = 'none';
    });
    btnExplorer.setAttribute('aria-pressed', 'false');
    btnSearch.setAttribute('aria-pressed', 'false');
    btnRun.setAttribute('aria-pressed', 'false');
    btnExtensions.setAttribute('aria-pressed', 'false');

    switch(name) {
      case 'explorer':
        explorerPanel.style.display = 'flex';
        btnExplorer.setAttribute('aria-pressed', 'true');
        break;
      case 'search':
        searchPanel.style.display = 'flex';
        btnSearch.setAttribute('aria-pressed', 'true');
        break;
      case 'run':
        runPanel.style.display = 'flex';
        btnRun.setAttribute('aria-pressed', 'true');
        break;
      case 'extensions':
        extensionsPanel.style.display = 'flex';
        btnExtensions.setAttribute('aria-pressed', 'true');
        break;
    }
  }

  // PS5 buttons events
  btnInsertTab.addEventListener('click', () => {
    insertAtCursor('  ');
  });
  btnInsertNewline.addEventListener('click', () => {
    insertAtCursor('\n');
  });

  // Close preview button
  btnClosePreview.addEventListener('click', () => {
    togglePreview(false);
  });

  // File add button
  btnAddFile.addEventListener('click', () => {
    addNewFile(newFileInput.value.trim());
  });

  // Search input event
  document.getElementById('search-input').addEventListener('input', e => {
    performSearch(e.target.value.trim());
  });

  // Sidebar buttons event listeners
  btnExplorer.addEventListener('click', () => showPanel('explorer'));
  btnSearch.addEventListener('click', () => showPanel('search'));
  btnRun.addEventListener('click', () => showPanel('run'));
  btnExtensions.addEventListener('click', () => showPanel('extensions'));

  // Editor input event (save & update status)
  codeEditorEl.addEventListener('input', () => {
    saveEditorContent();
    updateStatusBar();
  });

  // Update status bar on cursor movement
  codeEditorEl.addEventListener('click', updateStatusBar);
  codeEditorEl.addEventListener('keyup', updateStatusBar);

  // Initial load
  loadFiles();
  refreshFileTree();
  showPanel('explorer');

  // Open first file by default
  const firstFile = findFirstFile(files);
  if(firstFile) openFile(firstFile);

  // === Helpers ===

  function refreshFileTree() {
    renderFileTree(fileTreeEl, files);
  }
  function findFirstFile(tree, base='') {
    for(const key in tree) {
      if(isFolder(key)) {
        const found = findFirstFile(tree[key], base + key);
        if(found) return found;
      } else {
        return base + key;
      }
    }
    return null;
  }

</script>

</body>
</html>